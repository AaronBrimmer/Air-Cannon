Much of this code is not mine. Credit to the writers of the ColorPalette code.
